
{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Post List</title>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
     <link rel="stylesheet" href="{% static 'css/post_lists.css' %}">
     <script src="{% static 'js/post_like.js' %}">

     </script>

    <style>
        .navbar-text {
        margin-left:600px;
    font-style: italic;
    font-weight: bold;
}
.like-comments {
    font-size: 12px;  /* Adjust the font size as needed */
    padding: 4px 8px; /* Adjust padding to control button size */
}
    </style>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

</head>
<body>



    <!-- Navbar -->

    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top">
        <!-- Navbar content -->
        <!-- ... -->
    </nav>

    <!-- Jumbotron -->
    <div id="intro" class="p-5 text-center bg-light">
    <h1 class="mb-0 h4">"Exploring Minds and Musings"</h1>
        <br>
    <div class="buttons-container">
        {% if not user.is_authenticated %}
            <a href="{% url 'login' %}" class="btn btn-primary me-2">Login</a>
            <a href="{% url 'Register' %}" class="btn btn-secondary me-2">SignUp</a>
        {% else %}
            {% if user.userprofile.role == 'moderator' %}
                <a href="{% url 'approve_posts' %}" class="btn btn-success me-2">Approve Posts</a>
                <a href="{% url 'moderator_dashboard' %}" class="btn btn-warning me-2">Check Reported Posts</a>
                <a href="{% url 'logout' %}" class="btn btn-danger me-2">Logout</a>
            {% else %}
                <a href="{% url 'post' %}" class="btn btn-success me-2">Create Blog</a>
                <a href="{% url 'list' %}" class="btn btn-info me-2">Blog List</a>
                <a href="{% url 'logout' %}" class="btn btn-danger me-2">Logout</a>
                <a href="{% url 'profile_update' %}" class="btn btn-success me-2">Edit Profile</a>
            {% endif %}
        </div>
        <div class="welcome-user ml-auto">
            <span class="navbar-text welcome-message">User: <span class="italic-bold">{{ user.username }}</span></span>
        </div>
        {% endif %}
    </div>
</div>


    <!-- Main content -->
    <main class="mt-4 mb-5">
        <div class="container">
            <div class="row">
                <div class="col-md-8 mb-4">
                    <!-- Post Loop -->
                    {% if posts %}
                        <ul class="list-unstyled">
                            {% for post in posts reversed %}
                                <li class="mb-4 post-card">
                                    {% if post.post_image %}
                                        <img src="{{ post.post_image.url }}" alt="Post Image"
                                             class="img-fluid rounded-5 shadow-sm mb-3">
                                    {% endif %}
                                    <div>
                                        <h2>{{ post.post_title }}</h2>
                                        <p>{{ post.post_content|safe }}</p>

                                        <button class="btn btn-primary like-button" data-post-id="{{ post.id }}">Like</button>
                                        <span class="like-count ms-2">{{ post.like_count }}</span>
                                          {% if request.user == post.user %}
                                       <div class="btn-group mt-2 update-delete-buttons " role="group" style="float: right;">
                                                <a href="{% url 'update_post' post.id%}" class="btn btn-secondary small-button">Update</a>
                                                <a href="{% url 'delete_post' post.id%}" class="btn btn-danger small-button">delete</a>

                                       </div>
                                                     <br>
                                        <br>
                                          {% endif %}
                                              <!-- Suggestions Links -->
                                            <div class="suggestion-links mt-2">
                                                <a href="{% url 'submit_suggestion' post_id=post.id %}" class="btn btn-primary btn-sm">Submit Suggestion</a>
                                                <a href="{% url 'suggestions_list' post_id=post.id %}" class="btn btn-secondary btn-sm">Check Suggestions</a>
                                            </div>

                                    </div>

                                    <!-- Comments Loop -->
                                    <ul>
                                        <div class="comment-box">
                                        {% for comment in post.comments %}
                                         {% if comment.user.userprofile.image %}

                                        <div class=" bg-light ">
                                              <img src="{{ comment.user.userprofile.image.url }}" alt="Profile Image" class="rounded-image" width="50px">
                                                   {% endif %}

                                            <strong>{{ comment.user.username }}</strong>
                                                    <br>
                                                    {{ comment.description }}
                                                    {% if comment.attachment %}
                                                  <a href="{{ comment.attachment.url }}" target="_blank">Attachment File</a>
                                                     {% endif %}
<!--                                                   {{ comment.attachment }}-->
                                            <a href="{% url 'reply_comment' comment.id %}" class="small-button">Reply</a>

                                    {% if comment.parent_comment %}
                                        <div class="comment-reply mt-2">
<!--                                            <p class="mb-1">Reply to: {{ comment.parent_comment.user.username }}</p>-->
                                            <p>{{ comment.parent_comment.description }}</p>
                                        </div>

                                    {% endif %}
                                                <div class="comment">

                                                <button class="like-comments" data-comment-id="{{ comment.id }}">
                                                    {% if request.user in comment.liked_by.all %}
                                                        Unlike
                                                    {% else %}
                                                        Like
                                                    {% endif %}
                                                </button>
                                                <span class="like-count">{{ comment.liked_by.count }}</span>
                                            </div>
<!--                                            {% if request.user in comment.liked_by.all %}-->
<!--                                                <a href="{% url 'unlike_comment' comment.id %}">Unlike</a>-->
<!--                                            {% else %}-->
<!--                                                <a href="{% url 'like_comment' comment.id %}">Like</a>-->
<!--                                            {% endif %}-->
<!--                                            <p>Likes: {{ comment.liked_by.count }}</p>-->

                                            {% if request.user in comment.reported_by.all %}
                                                <a href="{% url 'unreport_comment' comment.id %}">Unreport</a>
                                            {% else %}
                                                <a href="{% url 'report_comment' comment.id %}">Report</a>
                                            {% endif %}

                                            </div>
                                        {% endfor %}
                                        <a href="{% url 'add_comment' post.id%}" class="btn small-button">Add Comment</a>
                                        </div>
                                        {% if user.is_authenticated %}
                                            <div class="report-section mt-3">
                                                {% if user in post.reported_by.all %}
                                                    <p class="already-reported">Already reported</p>
                                                {% else %}
                                                    <form method="post" action="{% url 'report_post' post_id=post.id %}">
                                                        {% csrf_token %}
                                                        <button type="submit" class="report-button">Report this post</button>
                                                    </form>
                                                {% endif %}
                                            </div>
                                        {% endif %}


                                    </ul>

                            {% endfor %}
                            </li>
                        </ul>
                    {% else %}
                        <p>No posts available.</p>
                    {% endif %}
                    <!-- End Post Loop -->
                </div>
                <!-- Grid column -->

                <!-- Sidebar -->
                <div class="col-md-4 mb-4">
                    <!-- Sidebar content (if any) -->
                </div>
                <!-- Sidebar -->
            </div>
            <!-- Grid row -->
        </div>

    </main>
    <!-- Main content -->


    <!-- jQuery and Bootstrap JS scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
 $(document).ready(function() {
    $('.like-comments').on('click', function() {
        var commentId = $(this).data('comment-id');
        var likeButton = $(this);
        var likeCount = likeButton.siblings('.like-count');  // Select the like count span

        $.ajax({
            type: 'POST',
            url: `/comment/${commentId}/like/`,
            data: {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.status === 'success') {
                    // Update button text based on action
                    if (response.action === 'liked') {
                        likeButton.text('Unlike');
                    } else if (response.action === 'unliked') {
                        likeButton.text('Like');
                    }
                    // Update like count
                    likeCount.text(response.like_count);
                } else {
                    alert(response.message);
                }
            },
            error: function(xhr) {
                alert('An error occurred. Please try again.');
            }
        });
    });
});
</script>



</body>
</html>
